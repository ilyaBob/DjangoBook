name: Django CI via Docker

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Клонируем репозиторий
      - uses: actions/checkout@v4

      # 2. Устанавливаем Docker (Ubuntu обычно уже имеет docker)
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # 3. Копируем .env.example или создаем временный .env для CI
      - name: Set up .env
        run: |
          echo "POSTGRES_DB=testdb" >> .env
          echo "POSTGRES_USER=testuser" >> .env
          echo "POSTGRES_PASSWORD=testpass" >> .env

      # 4. Собираем и поднимаем контейнеры
      - name: Build and run Docker Compose
        run: |
          docker compose -f docker-compose.yml up -d --build
          # Ждем, пока база данных поднимется
          sleep 10

      # 5. Запускаем тесты внутри web-контейнера
      - name: Run Django tests
        run: |
          docker compose exec web python manage.py test

      # 6. Останавливаем контейнеры после тестов
      - name: Tear down
        run: |
          docker compose down
